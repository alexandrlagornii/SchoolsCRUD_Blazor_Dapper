@page "/AccountManage/Users"
@rendermode InteractiveServer

@using SchoolsProjectBlazorDapper.Data.Account;
@using SchoolsProjectBlazorDapper.Components.AccountManage.Pages.Reusable;
@using MudBlazor;
@using Microsoft.AspNetCore.Authorization;
@using Microsoft.AspNetCore.Identity;

@inject NavigationManager NavigationManager
@inject UsersDbAccessLayer UsersDbAccessLayer
@inject UserManager<User> UserManager

@attribute [Authorize(Roles = "Admin")]

@if (UsersTable.Count == 0)
{
    <p>Loading...</p>
}
else
{
    <MudButton Variant="Variant.Outlined" Color="Color.Primary" @onclick="AddUserPageRedirect">Add</MudButton>
    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Disabled="@(SelectedUser.Id == null)" @onclick="DeleteUser">Delete</MudButton>
    <IdentityUsersTable _UsersTable="@UsersTable" @bind-SelectedUser="@SelectedUser" @bind-SelectedUser:event="SelectedUserChanged" />
}

@code {
    // Data Models
    List<UserViewModel> UsersTable = new();
    private UserViewModel SelectedUser = new();

    // Load Table
    protected override async Task OnInitializedAsync()
    {
        UsersTable = await UsersDbAccessLayer.GetUsersRoles();
    }

    private async Task DeleteUser()
    {
        var userToDelete = await UserManager.FindByIdAsync(SelectedUser.Id ?? string.Empty);

        if (userToDelete != null)
        {
            await UserManager.DeleteAsync(userToDelete);
            NavigationManager.NavigateTo(NavigationManager.Uri, true);
        }
    }

    private void AddUserPageRedirect()
    {
        NavigationManager.NavigateTo("/AccountManage/UserAdd");
    }
}
